---
layout: post
title: 안정적인 서비스 운영
description: >
  3/3 안정적인 서비스 운영
tags: [study]
comments: true
---

# 3/3 안정적인 서비스 운영



### 스토리지 스케일링

#### 분산파일 시스템

복제본 수를 일률적으로 적용할 필요가 없음  

​	: 요청이 많은 파일은 복제수를 늘리고, 보존 기한이 얼마 남지 않은 경우 복제 수를 줄인다. 

#### 사용성 따라

- 파일을 쌓아두기만 하는 용도인지
- IO가 발생하는지
- 최근 파일을 주로 사용하는지



### 빠른 배포 

> 배포가 큰일이 되면 안된다

### 빠른 롤백 

배포 중 장애가 났을 때 어떻게 롤백을 할 것인지. 빠른 롤백이 중요.

- 배포 전, 롤백에 필요한 작업 미리 준비.
  - 버전/패키지 미리 준비
  - 롤백 스크립트 미리 준비
- 롤백이 예상되는 배포의 경우.
  - 디비 변경이 있어도 롤백이 가능하도록 개발
  - QA를 정상 배포, 롤백 후 두가지에 대해 진행

### 설정 관리

모든 장비의 설정이 같은가?

설정 배포 - 바이너리 배포시 함께? / 설정은 따로 리포지토리 관리?



### 속도 개선

제일 첫 작업은 프로파일링.

> 프로파일링 : 실제 병목이 어디인지 파악하는 것

해결책 

1. **캐시** (redis 등)

   각 레이어별 적용 가능(DB, WAS, 웹 서버에서 각각)

   저장 방식 : 사용할 결과 그대로 or 구조화하여 저장

   지역성 고려 설계 

   - 시간적 지역성 : LRU
   - 공간적 지역성 : prefetch

2. 증설

3. **정책 변경**

   ex) 조회수가 꼭 정확해야하나?

   <u>조회 후 캐쉬</u>(write back) : 조회수를 캐쉬에 저장하여 업데이트 하다가 일정 주기(1분, 5분 등)로 DB를 업데이트



### 메모리

RAID 컨트롤러 

​	버퍼링 기능. RAID 컨트롤러가 데이터를 갖고 있다가 한 번에 디스크에 작성.

​	정책 : 배터리 충전 중에는 디스크에 바로 쓰기(Battery Backup Write Cache)



### 품질 관리

웹, WAS

구간별 처리 속도 관리



## 운영

### 메일 발송 

다량 발송의 경우 손이 많이 감

​	코드의 문제가 아니라 운영의 문제

​	장애 : COS 발송 장애 등

​		SPF(발송 IP등록), 수신 서버 정책 등

#### dove, 메일 발송 플랫폼

SMTP 서버 풀

지정한 IP에 발송하면 알아서 운영성 작업 처리 (발송 IP가 막히면 알아서 IP 변경)



### 자동화

신규 서버 설치 : 장비를 받아 10분내로 설치.

일상적인 응용 배포 

자동 복구 : 장애 시 루틴하게 하는 작업.(프로세스 재구동 등)



### 배치 작업

필요한 기본 인프라 : 실패시 알림 / 과거 작업 이력 조회 / 여러 서버 묶어 실행 

​							  ex) Jenkins



### 로그 처리 

주기 - 실시간? 시간 단위 

​		  ex) scribe 

보관 - 얼마나 오래 보관해야하나

조회 - 얼마나 많은 범위의 데이터를, 얼마나 빠르게

보안 - 개인정보는 저장하지 않도록



## 품질 관리

### Java APM

- pinpoint

- scouter

  

### DB

ORM을 쓰지 않으면, DBA쿼리 검수 필수

동적 쿼리를 없애도록

<u>슬로우 쿼리 자동 검출</u>



### 로깅

에러 로그 수집에 <u>Log&Crash</u> 활용



### 모니터링

경고와 장애 수준 분리 : 50%, 70%, 90% 등에 수준을 분리 하여 경고, 장애를 알려야 한다.

최저값 모니터링 : N개 이상일 때 처럼 최댓값 뿐 아니라 최저값도 알림 설정이 필요하다.

주기적으로 수치점검 : 시스템의 기능과 사용자 수는 계속 변한다. 경고, 장애, 최저 값 세수치는 주기적으로 변경이 필요하다.

테스트 활용하여 기능 체크 : 사용자 인터페이스 레벨의 테스틔 모듈을 주기적으로 돌려, 서비스 상태 체크(Jenkins)

무의미한 알람 받지 않도록 : 무시해도 되는 알람이라면 받지 않도록 설정.

연동 서비스/서버 모니터링 : 외부 API를 이용할 경우, 해당 API를 직접 체크

시스템 유틸리티 : **vmstat, mpstat, instate, ss(netstat), free, top, sar, ping**

HTTP 에러페이지 설정 : 사용자가 에러페이지를 새로고침해도 문제 생기지 않도록



### 흔한 장애 

​	로그 : 로그를 보지 않아 계속 쌓이는 문제

​	타임아웃 : 디폴트 값 사용 주의. 단위 확인 필요.

​					평균 응답 속도에 상응하는 타임아웃 설정.

​	에러 핸들링 : 소스코드에서 return 값 제대로 확인 하지 않는 경우

​	파일/디스크 관련 : 디스크 가용량이 부족하거나(지우지 않고 쌓인 로그)

​							   inode가 부족하거나(작은 파일을 많이 저장)

​							   FD_MAX가 작거나(file descripter)

​	L4 : L4를 적용했는데도, 정상 동작하지 않는 서버로 계속 요청이 가는 경우(HTTP의경우 L7 헬스체크)



### 장애 대응 

전파 : 메일링 리스트 이용하여 관련 있는 사람들에게 장애 사실을 전파.

​		 다른 서비스의 장애 원인이 우리의 장애 때문일 수 있다.

처리 : 유용한 스크립트 - 특정 N분간 접속한 IP/URI 빈도로 

회고 : TC 보강

​		 빠른 장애 대처 - 장애를 어떻게 알았는가?

​		 장애 예방
